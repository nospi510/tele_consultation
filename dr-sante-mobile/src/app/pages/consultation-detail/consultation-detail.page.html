<ion-header translucent>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/consultation-history" (click)="goToHome()"></ion-back-button>
    </ion-buttons>
    <ion-title>Consultation #{{ consultation.id }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" fullscreen>
  <div class="consultation-container">
    <ion-card class="consultation-card">
      <ion-card-header class="header-gradient">
        <ion-card-title>Votre Consultation</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="info-section">
          <ion-chip color="secondary">
            <ion-icon name="pulse-outline"></ion-icon>
            <ion-label>Symptômes : {{ consultation.symptoms }}</ion-label>
          </ion-chip>
          <ion-chip color="warning">
            <ion-icon name="medkit-outline"></ion-icon>
            <ion-label>Diagnostic : {{ consultation.diagnosis || 'En attente' }}</ion-label>
          </ion-chip>
          <ion-chip color="success">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            <ion-label>Statut : {{ consultation.status }}</ion-label>
          </ion-chip>
          <ion-chip color="tertiary">
            <ion-icon name="calendar-outline"></ion-icon>
            <ion-label>Date : {{ consultation.created_at | date:'medium' }}</ion-label>
          </ion-chip>
        </div>

        <ion-button expand="block" color="primary" (click)="joinCall()" *ngIf="callProposed && !inCall">
          Rejoindre l’appel vidéo
        </ion-button>

        <div class="video-call" *ngIf="inCall">
          <video #localVideo autoplay muted playsinline class="local-video"></video>
          <video #remoteVideo autoplay playsinline class="remote-video"></video>
          <ion-button expand="block" color="danger" (click)="endCall()">Terminer l’appel</ion-button>
        </div>

        <ion-list class="chat-list" *ngIf="!inCall">
          <ion-item *ngFor="let message of messages" [ngClass]="message.sender === 'Patient' ? 'chat-item patient' : 'chat-item doctor'" lines="none">
            <ion-avatar slot="start" [ngClass]="message.sender === 'Patient' ? 'patient-avatar' : 'doctor-avatar'">
              <ion-icon [name]="message.sender === 'Patient' ? 'person' : 'medkit'"></ion-icon>
            </ion-avatar>
            <ion-label class="chat-message">
              <h3>{{ message.sender }}</h3>
              <p>{{ message.text }}</p>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="isDoctorTyping" color="tertiary" lines="none">
            <ion-label>Médecin est en train d’écrire...</ion-label>
            <ion-spinner name="dots" slot="end"></ion-spinner>
          </ion-item>
        </ion-list>

        <ion-item class="message-input" lines="none" *ngIf="consultation.status !== 'terminée' && !inCall">
          <ion-textarea [(ngModel)]="newMessage" placeholder="Votre message..." rows="2" (ionInput)="onTyping($event)" auto-grow></ion-textarea>
          <ion-button slot="end" fill="clear" (click)="continueConsultation()" [disabled]="!newMessage">
            <ion-icon name="send" color="primary"></ion-icon>
          </ion-button>
        </ion-item>

        <ion-text *ngIf="consultation.status === 'terminée' && !inCall" class="completed-text">
          Cette consultation est terminée.
        </ion-text>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>