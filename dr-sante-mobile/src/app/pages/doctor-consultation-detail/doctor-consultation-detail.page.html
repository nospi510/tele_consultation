<ion-header translucent>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/doctor-dashboard" (click)="goToHome()"></ion-back-button>
    </ion-buttons>
    <ion-title>Consultation #{{ consultation.id }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" fullscreen>
  <div class="consultation-container">
    <ion-card class="consultation-card">
      <ion-card-header class="header-gradient">
        <ion-card-title>Détails Consultation</ion-card-title>
        <ion-card-subtitle>Patient : {{ consultation.patient_name }}</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="info-section">
          <ion-chip color="secondary">
            <ion-icon name="pulse-outline"></ion-icon>
            <ion-label>Symptômes : {{ consultation.symptoms }}</ion-label>
          </ion-chip>
          <ion-chip color="warning">
            <ion-icon name="medkit-outline"></ion-icon>
            <ion-label>Diagnostic : {{ consultation.diagnosis || 'En attente' }}</ion-label>
          </ion-chip>
          <ion-chip color="success">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            <ion-label>Statut : {{ consultation.status }}</ion-label>
          </ion-chip>
        </div>

        <ion-button expand="block" color="primary" (click)="proposeCall()" *ngIf="!inCall">
          Proposer un appel vidéo
        </ion-button>

        <div class="video-call" *ngIf="inCall">
          <video #localVideo autoplay muted playsinline class="local-video"></video>
          <video #remoteVideo autoplay playsinline class="remote-video"></video>
          <ion-item class="status-select" lines="none">
            <ion-label>Statut</ion-label>
            <ion-select [(ngModel)]="selectedStatus" (ionChange)="updateStatus()" interface="popover">
              <ion-select-option *ngFor="let status of statusOptions" [value]="status">{{ status }}</ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item class="message-input" lines="none">
            <ion-textarea [(ngModel)]="newMessage" placeholder="Écrire un diagnostic..." rows="2" (ionInput)="onTyping($event)" auto-grow></ion-textarea>
            <ion-button slot="end" fill="clear" (click)="continueConsultation()" [disabled]="!newMessage">
              <ion-icon name="send" color="primary"></ion-icon>
            </ion-button>
          </ion-item>
          <ion-button expand="block" color="danger" (click)="endCall()">Terminer l’appel</ion-button>
        </div>

        <ion-list class="chat-list" *ngIf="!inCall">
          <ion-item *ngFor="let message of messages" [ngClass]="message.sender === 'Médecin' ? 'chat-item doctor' : 'chat-item patient'" lines="none">
            <ion-avatar slot="start" [ngClass]="message.sender === 'Médecin' ? 'doctor-avatar' : 'patient-avatar'">
              <ion-icon [name]="message.sender === 'Médecin' ? 'medkit' : 'person'"></ion-icon>
            </ion-avatar>
            <ion-label class="chat-message">
              <h3>{{ message.sender }}</h3>
              <p>{{ message.text }}</p>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="isPatientTyping" color="tertiary" lines="none">
            <ion-label>Patient est en train d’écrire...</ion-label>
            <ion-spinner name="dots" slot="end"></ion-spinner>
          </ion-item>
        </ion-list>

        <ion-item class="status-select" lines="none" *ngIf="!inCall">
          <ion-label>Statut</ion-label>
          <ion-select [(ngModel)]="selectedStatus" (ionChange)="updateStatus()" interface="popover">
            <ion-select-option *ngFor="let status of statusOptions" [value]="status">{{ status }}</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item class="message-input" lines="none" *ngIf="!inCall">
          <ion-textarea [(ngModel)]="newMessage" placeholder="Votre message..." rows="2" (ionInput)="onTyping($event)" auto-grow></ion-textarea>
          <ion-button slot="end" fill="clear" (click)="continueConsultation()" [disabled]="!newMessage">
            <ion-icon name="send" color="primary"></ion-icon>
          </ion-button>
        </ion-item>

        <ion-item class="reminder-input" lines="none" *ngIf="!inCall">
          <ion-textarea [(ngModel)]="reminderMessage" placeholder="Rappel pour le patient..." rows="2" auto-grow></ion-textarea>
          <ion-button slot="end" fill="clear" (click)="sendReminder()" [disabled]="!reminderMessage">
            <ion-icon name="alarm" color="success"></ion-icon>
          </ion-button>
        </ion-item>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>