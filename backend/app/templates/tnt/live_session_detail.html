{% extends 'base.html' %}
{% block title %}{{ session.title }}{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/live_session_details.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12"></script>
</head>
<body>
    <div class="live-container">
        <!-- En-tête -->
        <header class="live-header">
            <h1>{{ session.title }}</h1>
            <p>Hôte : {{ session.host.fullname }}</p>
            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
        </header>

        <!-- Section vidéo -->
        <section class="video-section">
            <h2>Diffusion en direct</h2>
            <div id="video-container">
                <video id="video-player" controls autoplay muted>
                    Votre navigateur ne supporte pas la vidéo.
                </video>
                <div id="no-stream-message">
                    <p>Aucune diffusion en cours pour le moment.</p>
                </div>
            </div>
            {% if is_broadcaster %}
                <div id="broadcaster-controls">
                    <button id="start-broadcast" class="btn btn-primary">Démarrer la diffusion</button>
                    <button id="stop-broadcast" class="btn btn-danger" style="display: none;">Arrêter la diffusion</button>
                </div>
            {% endif %}
        </section>

            <!-- Contenu principal (questions + quiz + file/contrôles) -->
        
            <!-- Questions -->
            <section class="questions-section">
                <h2>Questions</h2>
                <div id="questions-status">
                    {% if questions_enabled %}
                        <p class="status-enabled">Les questions sont activées.</p>
                        <div id="question-form">
                            <label for="question_text">Poser une question</label>
                            <textarea id="question_text" name="question_text" rows="3"></textarea>
                            <button id="submit-question" class="btn btn-primary">Envoyer</button>
                        </div>
                    {% else %}
                        <p class="status-disabled">Les questions sont désactivées.</p>
                    {% endif %}
                </div>
                <ul id="questions-list">
                    {% for q in questions %}
                        <li class="question-card" data-question-id="{{ q.id }}">
                            <div class="question-content">
                                <p><strong>{{ q.user }} :</strong> {{ q.question_text }}</p>
                                {% if q.answer_text %}
                                    <div class="answer-content">
                                        <p><strong>Réponse :</strong> {{ q.answer_text }}</p>
                                    </div>
                                {% endif %}
                                {% if user.role == 'doctor' and not q.answer_text %}
                                    <div class="answer-form">
                                        <textarea class="answer-text" rows="2" placeholder="Votre réponse..."></textarea>
                                        <button class="btn btn-answer" onclick="answerQuestion({{ q.id }})">Répondre</button>
                                    </div>
                                {% endif %}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </section>


            <!-- Quiz -->
            <div class="container mt-4">
                <h2>Gestion des Quiz</h2>
                <div id="quiz-section">
                    {% if user.role == 'doctor' %}
                        <div class="mb-3">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createQuizModal">Créer un quiz</button>
                        </div>
                    {% endif %}
                    <div id="quiz-status"><p class="text-muted">Aucun quiz activé.</p></div>
                    {% if user.role == 'doctor' %}
                        <div id="quiz-list" class="mb-3">
                            {% if quizzes %}
                                <h4>Quiz créés</h4>
                                <ul class="list-group">
                                    {% for quiz in quizzes %}
                                        <li class="list-group-item glass-effect d-flex justify-content-between align-items-center">
                                            <span>{{ quiz.question }}</span>
                                            <div>
                                                <button class="btn btn-success btn-sm me-2" onclick="activateQuiz({{ quiz.quiz_id }})">Activer</button>
                                                <button class="btn btn-danger btn-sm" onclick="deleteQuiz({{ quiz.quiz_id }})">Supprimer</button>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted">Aucun quiz créé.</p>
                            {% endif %}
                        </div>
                    {% endif %}
                    <div id="quiz-content" style="display: none;"></div>
                    <div id="quiz-results" style="display: none;"></div>
                    {% if user.role == 'doctor' %}
                        <button id="disable-quiz" class="btn btn-warning" style="display: none;" onclick="disableQuiz()">Désactiver le quiz</button>
                    {% endif %}
                </div>
            </div>

            <!-- Modal pour créer un quiz -->
            <div class="modal fade" id="createQuizModal" tabindex="-1" aria-labelledby="createQuizModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="createQuizModalLabel">Créer un quiz</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="create-quiz-form">
                                <div class="mb-3">
                                    <label for="quiz-question" class="form-label">Question</label>
                                    <input type="text" class="form-control" id="quiz-question" required>
                                </div>
                                <div class="mb-3">
                                    <label for="option-0" class="form-label">Option 1</label>
                                    <input type="text" class="form-control" id="option-0" required>
                                </div>
                                <div class="mb-3">
                                    <label for="option-1" class="form-label">Option 2</label>
                                    <input type="text" class="form-control" id="option-1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="option-2" class="form-label">Option 3</label>
                                    <input type="text" class="form-control" id="option-2" required>
                                </div>
                                <div class="mb-3">
                                    <label for="option-3" class="form-label">Option 4</label>
                                    <input type="text" class="form-control" id="option-3" required>
                                </div>
                                <div class="mb-3">
                                    <label for="correct-option" class="form-label">Bonne réponse</label>
                                    <select class="form-control" id="correct-option" required>
                                        <option value="" disabled selected>Choisir la bonne réponse</option>
                                        <option value="0">Option 1</option>
                                        <option value="1">Option 2</option>
                                        <option value="2">Option 3</option>
                                        <option value="3">Option 4</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="quiz-duration" class="form-label">Durée (secondes)</label>
                                    <input type="number" class="form-control" id="quiz-duration" value="30" min="10" required>
                                </div>
                                <button type="button" class="btn btn-success" onclick="createQuiz()">Créer</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- File d'attente et contrôles -->
            <aside class="sidebar">
                <!-- File d'attente -->
                <section class="queue-section">
                    <h2>File d'attente vidéo</h2>
                    <ul id="video-queue-list">
                        {% for entry in video_queue %}
                            <li data-user-id="{{ entry.user_id }}">Position {{ entry.position }} : {{ entry.user }}</li>
                        {% endfor %}
                    </ul>
                    <button id="join-queue" class="btn btn-primary">Rejoindre la file</button>
                    <button id="leave-queue" class="btn btn-secondary">Quitter la file</button>
                </section>

                <!-- Contrôles diffuseur -->
                {% if user.role == 'doctor' %}
                    <section class="controls-section">
                        <h2>Contrôles diffuseur</h2>
                        <button id="enable-questions" class="btn btn-success">Activer les questions</button>
                        <button id="disable-questions" class="btn btn-warning">Désactiver les questions</button>
                        <button id="next-queue" class="btn btn-primary">Prochain utilisateur</button>
                        <button id="kick-queue" class="btn btn-danger">Couper l'utilisateur actif</button>
                    </section>
                {% endif %}
            </aside>
       
    </div>



    <!-- Modal pour créer un quiz -->
    {% if user.role == 'doctor' %}
    <div class="modal fade" id="createQuizModal" tabindex="-1" aria-labelledby="createQuizModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content glass-effect">
                <div class="modal-header">
                    <h5 class="modal-title" id="createQuizModalLabel">Créer un Quiz</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-quiz-form">
                        <div class="mb-3">
                            <label for="quiz-question" class="form-label">Question</label>
                            <textarea id="quiz-question" class="form-control" placeholder="Entrez la question" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="option-0" class="form-label">Option 1</label>
                            <input type="text" id="option-0" class="form-control" placeholder="Option 1" required>
                        </div>
                        <div class="mb-3">
                            <label for="option-1" class="form-label">Option 2</label>
                            <input type="text" id="option-1" class="form-control" placeholder="Option 2" required>
                        </div>
                        <div class="mb-3">
                            <label for="option-2" class="form-label">Option 3</label>
                            <input type="text" id="option-2" class="form-control" placeholder="Option 3" required>
                        </div>
                        <div class="mb-3">
                            <label for="option-3" class="form-label">Option 4</label>
                            <input type="text" id="option-3" class="form-control" placeholder="Option 4" required>
                        </div>
                        <div class="mb-3">
                            <label for="correct-option" class="form-label">Bonne réponse</label>
                            <select id="correct-option" class="form-select" required>
                                <option value="0">Option 1</option>
                                <option value="1">Option 2</option>
                                <option value="2">Option 3</option>
                                <option value="3">Option 4</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="quiz-duration" class="form-label">Durée (secondes)</label>
                            <input type="number" id="quiz-duration" class="form-control" value="30" min="10" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Créer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        // Connexion à SocketIO
        const socket = io('/live', { transports: ['websocket'], auth: { token: localStorage.getItem('access_token') } });

        // Rejoindre la session
        socket.on('connect', () => {
            console.log('Connecté à SocketIO');
            socket.emit('join_session', {
                session_id: {{ session.id }},
                user_id: {{ user.id }}
            });
        });

        // Gérer les nouvelles questions
        socket.on('new_question', (data) => {
            console.log('Nouvelle question reçue:', data);
            const questionsList = document.getElementById('questions-list');
            const newQuestion = document.createElement('li');
            newQuestion.className = 'question-card';
            newQuestion.dataset.questionId = data.id;
            newQuestion.innerHTML = `
                <div class="question-content">
                    <p><strong>${data.user} :</strong> ${data.question_text}</p>
                    {% if user.role == 'doctor' %}
                        <div class="answer-form">
                            <textarea class="answer-text" rows="2" placeholder="Votre réponse..."></textarea>
                            <button class="btn btn-answer" onclick="answerQuestion(${data.id})">Répondre</button>
                        </div>
                    {% endif %}
                </div>
            `;
            questionsList.appendChild(newQuestion);
        });

        // Gérer les réponses aux questions
        socket.on('new_answer', (data) => {
            console.log('Nouvelle réponse reçue:', data);
            const questionItem = document.querySelector(`[data-question-id="${data.question_id}"]`);
            if (questionItem) {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer-content';
                answerDiv.innerHTML = `<p><strong>Réponse :</strong> ${data.answer_text}</p>`;
                const questionContent = questionItem.querySelector('.question-content');
                questionContent.appendChild(answerDiv);
                const answerForm = questionItem.querySelector('.answer-form');
                if (answerForm) answerForm.remove();
            }
        });

        // Gérer les mises à jour de la file d'attente vidéo
        socket.on('video_queue_update', (data) => {
            console.log('Mise à jour file d’attente:', data);
            const queueList = document.getElementById('video-queue-list');
            if (data.action === 'join') {
                const newEntry = document.createElement('li');
                newEntry.dataset.userId = data.user_id;
                newEntry.innerHTML = `Position ${data.position} : ${data.user}`;
                queueList.appendChild(newEntry);
            } else if (data.action === 'leave') {
                const entry = document.querySelector(`[data-user-id="${data.user_id}"]`);
                if (entry) entry.remove();
            }
            const entries = queueList.querySelectorAll('li');
            entries.forEach((entry, index) => {
                entry.innerHTML = `Position ${index + 1} : ${entry.textContent.split(': ')[1]}`;
            });
        });

        // Gérer l'activation des questions
        socket.on('questions_enabled', (data) => {
            console.log('Questions activées:', data);
            const statusDiv = document.getElementById('questions-status');
            statusDiv.innerHTML = `
                <p class="status-enabled">Les questions sont activées.</p>
                <div id="question-form">
                    <label for="question_text">Poser une question</label>
                    <textarea id="question_text" name="question_text" rows="3"></textarea>
                    <button id="submit-question" class="btn btn-primary">Envoyer</button>
                </div>
            `;
            document.getElementById('submit-question').addEventListener('click', submitQuestion);
        });

        // Gérer la désactivation des questions
        socket.on('questions_disabled', (data) => {
            console.log('Questions désactivées:', data);
            const statusDiv = document.getElementById('questions-status');
            statusDiv.innerHTML = `<p class="status-disabled">Les questions sont désactivées.</p>`;
        });

        socket.on('new_quiz', (data) => {
                console.log('Nouveau quiz reçu:', data);
                if (data.session_id === {{ session.id }} && '{{ user.role }}' === 'doctor') {
                    // Recharger la page pour mettre à jour la liste des quiz
                    window.location.reload();
                }
            });

            socket.on('quiz_enabled', (data) => {
                console.log('Quiz activé pour session:', data.session_id);
                if (data.session_id === {{ session.id }}) {
                    document.getElementById('quiz-status').innerHTML = '<p class="status-enabled">Le quiz est activé.</p>';
                    displayQuiz(data);
                    {% if user.role == 'doctor' %}
                        document.getElementById('disable-quiz').style.display = 'block';
                    {% endif %}
                }
            });

            socket.on('quiz_disabled', (data) => {
                console.log('Quiz désactivé pour session:', data.session_id);
                if (data.session_id === {{ session.id }}) {
                    document.getElementById('quiz-status').innerHTML = '<p class="status-disabled">Le quiz est désactivé.</p>';
                    document.getElementById('quiz-content').style.display = 'none';
                    document.getElementById('quiz-results').style.display = 'none';
                    {% if user.role == 'doctor' %}
                        document.getElementById('disable-quiz').style.display = 'none';
                    {% endif %}
                }
            });

            socket.on('quiz_deleted', (data) => {
                console.log('Quiz supprimé:', data);
                if (data.session_id === {{ session.id }} && '{{ user.role }}' === 'doctor') {
                    window.location.reload();
                }
            });

        // Fonction pour afficher le message "Aucune diffusion"
        function showNoStreamMessage() {
            console.log('Aucune diffusion active, affichage du message');
            const videoPlayer = document.getElementById('video-player');
            const noStreamMessage = document.getElementById('no-stream-message');
            videoPlayer.style.display = 'none';
            noStreamMessage.style.display = 'block';
            videoPlayer.srcObject = null;
        }

        // Fonction pour charger la vidéo HLS
        function loadVideo(hlsUrl) {
            console.log('Chargement vidéo HLS:', hlsUrl);
            sessionStorage.setItem('currentHlsUrl', hlsUrl);
            const videoPlayer = document.getElementById('video-player');
            const noStreamMessage = document.getElementById('no-stream-message');
            videoPlayer.innerHTML = '';
            const source = document.createElement('source');
            source.setAttribute('type', 'application/x-mpegURL');
            source.setAttribute('src', hlsUrl);
            videoPlayer.appendChild(source);

            videoPlayer.style.display = 'block';
            noStreamMessage.style.display = 'none';

            if (Hls.isSupported() && !videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                console.log('Utilisation de hls.js pour charger le flux');
                const hls = new Hls({
                    enableWorker: true,
                    maxBufferLength: 15,
                    liveSyncDurationCount: 3,
                    liveMaxLatencyDurationCount: 6,
                    fragLoadingTimeOut: 10000,
                    manifestLoadingTimeOut: 5000,
                    levelLoadingTimeOut: 10000,
                    capLevelToPlayerSize: true,
                    progressive: true
                });
                hls.loadSource(hlsUrl);
                hls.attachMedia(videoPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    const codecs = hls.levels[0]?.codecs || null;
                    console.log('Manifeste HLS chargé, codecs:', codecs);
                    if (!codecs || !codecs.includes('avc1')) {
                        console.warn('Codec vidéo manquant ou non détecté');
                        alert('Le flux vidéo n’est pas compatible avec ce navigateur. Essayez Chrome, Firefox ou Safari.');
                        hls.destroy();
                        showNoStreamMessage();
                        return;
                    }
                    videoPlayer.play().catch(err => {
                        console.error('Erreur lecture HLS:', err);
                    });
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('Erreur HLS détaillée:', data);
                    if (data.details === 'bufferStalledError') {
                        console.log('Tentative de récupération après bufferStalledError');
                        hls.startLoad();
                    }
                    if (data.fatal) {
                        console.error('Erreur fatale HLS:', data);
                        hls.destroy();
                        alert('Erreur critique lors du chargement du flux vidéo: ' + (data.err?.message || 'Erreur inconnue'));
                        showNoStreamMessage();
                    }
                });
                hls.on(Hls.Events.LEVEL_LOADED, (event, data) => {
                    console.log('Niveau HLS chargé:', data);
                });
                hls.on(Hls.Events.FRAG_LOADED, (event, data) => {
                    console.log('Fragment HLS chargé:', data.frag.url);
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                console.log('Utilisation du support HLS natif');
                videoPlayer.load();
                videoPlayer.play().catch(err => {
                    console.error('Erreur lecture vidéo natif:', err);
                    alert('Erreur lors de la lecture du flux vidéo. Essayez un autre navigateur.');
                    showNoStreamMessage();
                });
            } else {
                console.error('HLS non supporté par ce navigateur');
                alert('Votre navigateur ne supporte pas HLS. Essayez Chrome, Firefox ou Safari.');
                showNoStreamMessage();
            }
        }

        // Gérer le changement de flux vidéo
        socket.on('video_stream_switch', (data) => {
            console.log('Événement video_stream_switch reçu:', data);
            loadVideo(data.hls_url);
        });

        // Gérer l'événement start_broadcast
        socket.on('start_broadcast', (data) => {
            console.log('Événement start_broadcast reçu:', data);
            loadVideo(data.hls_url);
        });

        // Déconnexion
        socket.on('disconnect', () => {
            console.log('Déconnecté de SocketIO');
        });

        // Fonction pour envoyer des requêtes POST avec authentification
        async function sendPostRequest(url, data) {
        const token = localStorage.getItem('access_token'); 
        if (!token) {
            console.error('Jeton d’authentification manquant');
            alert('Erreur: Veuillez vous reconnecter pour continuer.');
            window.location.href = '/api/auth/login';
            return false;
        }
        try {
            console.log('Envoi POST:', { url, data });
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            console.log('Réponse sendPostRequest:', { status: response.status, ok: response.ok });
            if (response.status === 401) {
                alert('Session expirée. Veuillez vous reconnecter.');
                window.location.href = '/api/auth/login';
                return false;
            }
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erreur sendPostRequest:', errorText);
                throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
            }
            return true;
        } catch (error) {
            console.error('Erreur dans sendPostRequest:', error);
            alert(`Erreur: ${error.message}`);
            return false;
        }
    }     
       
        // Gestion des actions sans actualisation
        async function submitQuestion(event) {
            event.preventDefault();
            const questionText = document.getElementById('question_text').value;
            if (!questionText.trim()) {
                alert('Veuillez entrer une question.');
                return;
            }
            const success = await sendPostRequest('{{ url_for("tnt.send_question", session_id=session.id) }}', {
                question_text: questionText
            });
            if (success) {
                document.getElementById('question_text').value = '';
            }
        }

        async function answerQuestion(questionId) {
            const questionItem = document.querySelector(`[data-question-id="${questionId}"]`);
            const answerText = questionItem.querySelector('.answer-text').value;
            if (!answerText.trim()) {
                alert('Veuillez entrer une réponse.');
                return;
            }
            const success = await sendPostRequest(`{{ url_for('tnt.answer_question', session_id=session.id, question_id=0) }}`.replace('0', questionId), {
                answer_text: answerText
            });
            if (success) {
                questionItem.querySelector('.answer-text').value = '';
            }
        }

        async function joinQueue(event) {
            event.preventDefault();
            await sendPostRequest('{{ url_for("tnt.join_video_queue", session_id=session.id) }}', {});
        }

        async function leaveQueue(event) {
            event.preventDefault();
            await sendPostRequest('{{ url_for("tnt.leave_video_queue", session_id=session.id) }}', {});
        }

        async function enableQuestions(event) {
            event.preventDefault();
            await sendPostRequest('{{ url_for("tnt.enable_questions", session_id=session.id) }}', {});
        }

        async function disableQuestions(event) {
            event.preventDefault();
            await sendPostRequest('{{ url_for("tnt.disable_questions", session_id=session.id) }}', {});
        }

        async function nextQueue(event) {
            event.preventDefault();
            await sendPostRequest('{{ url_for("tnt.next_video_queue", session_id=session.id) }}', {});
        }

        async function kickQueue(event) {
            event.preventDefault();
            await sendPostRequest('{{ url_for("tnt.kick_video_queue", session_id=session.id) }}', {});
        }



        async function createQuiz() {
            console.log('Création quiz');
            const question = document.getElementById('quiz-question').value;
            const options = [
                document.getElementById('option-0').value,
                document.getElementById('option-1').value,
                document.getElementById('option-2').value,
                document.getElementById('option-3').value
            ];
            const correct_option = parseInt(document.getElementById('correct-option').value);
            const duration = parseInt(document.getElementById('quiz-duration').value);
            if (!question || options.some(opt => !opt) || isNaN(correct_option) || ![0,1,2,3].includes(correct_option) || isNaN(duration) || duration < 10) {
                alert('Veuillez remplir tous les champs correctement.');
                return;
            }
            const success = await sendPostRequest('{{ url_for("tnt.create_quiz", session_id=session.id) }}', {
                question,
                options,
                correct_option,
                duration
            });
            if (success) {
                console.log('Quiz créé avec succès');
                document.getElementById('create-quiz-form').reset();
                document.getElementById('quiz-duration').value = 30;
                bootstrap.Modal.getInstance(document.getElementById('createQuizModal')).hide();
                window.location.reload();
            }
        }

        async function activateQuiz(quizId) {
            console.log('Activation quiz:', quizId);
            const success = await sendPostRequest(`{{ url_for("tnt.enable_quiz", session_id=session.id) }}?quiz_id=${quizId}`, {});
            if (success) {
                console.log('Quiz activé avec succès');
            }
        }

        async function deleteQuiz(quizId) {
            console.log('Suppression quiz:', quizId);
            if (confirm('Voulez-vous vraiment supprimer ce quiz ?')) {
                const success = await sendPostRequest(`{{ url_for("tnt.delete_quiz", session_id=session.id, quiz_id=0) }}`.replace('0', quizId), {});
                if (success) {
                    console.log('Quiz supprimé avec succès');
                    window.location.reload();
                }
            }
        }

        async function disableQuiz() {
            console.log('Désactivation quiz');
            const success = await sendPostRequest('{{ url_for("tnt.disable_quiz", session_id=session.id) }}', {});
            if (success) {
                console.log('Quiz désactivé avec succès');
                document.getElementById('disable-quiz').style.display = 'none';
            }
        }

        function displayQuiz(data) {
            console.log('Affichage quiz:', data);
            const quizContent = document.getElementById('quiz-content');
            quizContent.style.display = 'block';
            document.getElementById('quiz-results').style.display = 'none';
            quizContent.innerHTML = `
                <div class="quiz-card card shadow-sm glass-effect mb-3" style="background-color: #333; color: #fff; border: 1px solid #555;">
                    <div class="card-body">
                        <h5 style="color: #fff;">${data.question}</h5>
                        <div id="quiz-timer" class="mb-3" style="color: #0f0;">Temps restant : ${data.duration}s</div>
                        <div id="quiz-options">
                            ${data.options.map((option, index) => `
                                <button class="quiz-option btn w-100 mb-2" style="background-color: #007bff; color: #fff; border: 1px solid #0056b3;" data-option="${index}">${option}</button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            const isDoctor = '{{ user.role }}' === 'doctor';
            console.log('Rôle utilisateur:', '{{ user.role }}', 'isDoctor:', isDoctor);
            if (!isDoctor) {
                startTimer(data.expires_at, data.duration, data);
                document.querySelectorAll('.quiz-option').forEach(button => {
                    button.disabled = false;
                    button.addEventListener('click', async () => {
                        console.log('Clic sur option:', button.dataset.option);
                        document.querySelectorAll('.quiz-option').forEach(btn => btn.disabled = true);
                        const selectedOption = parseInt(button.dataset.option);
                        const quizAnswerUrl = `/api/tnt/live-session/{{ session.id }}/quiz/${data.quiz_id}/answer`;
                        console.log('Envoi réponse quiz:', { quiz_id: data.quiz_id, selected_option: selectedOption });
                        const success = await sendPostRequest(quizAnswerUrl, {
                            selected_option: selectedOption
                        });
                        if (success) {
                            showQuizResult(data);
                        } else {
                            document.querySelectorAll('.quiz-option').forEach(btn => btn.disabled = false);
                        }
                    }, { once: true });
                });
            } else {
                document.querySelectorAll('.quiz-option').forEach(button => button.disabled = true);
            }
        }

        function startTimer(expiresAt, duration, quizData) {
            console.log('Démarrage timer, expiresAt:', expiresAt, 'duration:', duration);
            const timerDiv = document.getElementById('quiz-timer');
            if (!timerDiv) {
                console.error('quiz-timer introuvable');
                showQuizResult(quizData);
                return;
            }
            const endTime = new Date(expiresAt).getTime();
            if (isNaN(endTime) || endTime <= Date.now()) {
                console.error('expiresAt invalide ou déjà expiré:', expiresAt);
                showQuizResult(quizData);
                return;
            }
            let secondsLeft = Math.min(duration, Math.floor((endTime - Date.now()) / 1000));
            timerDiv.textContent = `Temps restant : ${secondsLeft}s`;
            const interval = setInterval(() => {
                secondsLeft = Math.max(0, secondsLeft - 1);
                console.log('Timer tick:', secondsLeft);
                timerDiv.textContent = `Temps restant : ${secondsLeft}s`;
                if (secondsLeft <= 0) {
                    clearInterval(interval);
                    console.log('Timer expiré');
                    document.querySelectorAll('.quiz-option').forEach(button => button.disabled = true);
                    showQuizResult(quizData);
                }
            }, 1000);
        }

        function showQuizResult(data) {
            console.log('Affichage résultat quiz:', data);
            const quizContent = document.getElementById('quiz-content');
            quizContent.style.display = 'block';
            document.getElementById('quiz-results').style.display = 'none';
            quizContent.innerHTML = `
                <div class="quiz-card card shadow-sm glass-effect mb-3" style="background-color: #333; color: #fff; border: 1px solid #555;">
                    <div class="card-body">
                        <h5 style="color: #fff;">${data.question}</h5>
                        <div id="quiz-options">
                            ${data.options.map((option, index) => `
                                <button class="quiz-option btn w-100 mb-2" style="background-color: ${index === data.correct_option ? '#28a745' : '#6c757d'}; color: #fff; border: 1px solid ${index === data.correct_option ? '#218838' : '#5a6268'};" disabled>${option}</button>
                            `).join('')}
                        </div>
                        <p class="text-success mt-3">Bonne réponse : ${data.options[data.correct_option]}</p>
                    </div>
                </div>
            `;
        }

        // Attacher les événements aux boutons
        const submitQuestionButton = document.getElementById('submit-question');
        if (submitQuestionButton) submitQuestionButton.addEventListener('click', submitQuestion);

        document.getElementById('join-queue').addEventListener('click', joinQueue);
        document.getElementById('leave-queue').addEventListener('click', leaveQueue);

        {% if user.role == 'doctor' %}
            document.getElementById('enable-questions').addEventListener('click', enableQuestions);
            document.getElementById('disable-questions').addEventListener('click', disableQuestions);
            document.getElementById('next-queue').addEventListener('click', nextQueue);
            document.getElementById('kick-queue').addEventListener('click', kickQueue);
            document.getElementById('create-quiz-form').addEventListener('submit', createQuiz);
        {% endif %}

        {% if is_broadcaster %}
            let peerConnection = null;
            let localStream = null;

            const startBroadcastButton = document.getElementById('start-broadcast');
            const stopBroadcastButton = document.getElementById('stop-broadcast');

            startBroadcastButton.addEventListener('click', async () => {
                try {
                    console.log('Étape 1: Demande d’accès caméra/micro');
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    console.log('Étape 2: Flux caméra/micro obtenu:', {
                        videoTracks: localStream.getVideoTracks().length,
                        audioTracks: localStream.getAudioTracks().length,
                        tracks: localStream.getTracks()
                    });

                    console.log('Étape 3: Affichage flux local dans video-player');
                    const videoPlayer = document.getElementById('video-player');
                    videoPlayer.srcObject = localStream;
                    videoPlayer.play().catch(err => console.error('Erreur lecture flux local:', err));

                    console.log('Étape 4: Configuration WebRTC');
                    const configuration = {
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    };
                    peerConnection = new RTCPeerConnection(configuration);

                    console.log('Étape 5: Ajout des pistes');
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });

                    peerConnection.onicecandidate = (event) => {
                        console.log('Étape 6: ICE candidate:', event.candidate || 'Fin des candidats');
                    };

                    peerConnection.onconnectionstatechange = () => {
                        console.log('Étape 7: État connexion WebRTC:', peerConnection.connectionState);
                        if (peerConnection.connectionState === 'connected') {
                            console.log('WebRTC connecté avec succès');
                        }
                    };

                    console.log('Étape 8: Création offre SDP');
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    console.log('Étape 9: Offre SDP:', offer.sdp);

                    const endpoint = 'http://localhost:1985/rtc/v1/publish/';
                    console.log('Étape 10: Envoi requête POST à:', endpoint);
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            sdp: offer.sdp,
                            streamurl: `/live/{{ session.id }}_{{ user.id }}`
                        })
                    });

                    console.log('Étape 11: Réponse reçue, statut:', response.status);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Erreur SRS:', errorText);
                        throw new Error(`Erreur SRS HTTP ${response.status}: ${errorText}`);
                    }

                    let data;
                    try {
                        data = await response.json();
                        console.log('Étape 12: Réponse SRS:', data);
                    } catch (e) {
                        const errorText = await response.text();
                        console.error('Réponse brute non-JSON:', errorText);
                        throw new Error(`Erreur parsing JSON: ${e.message}`);
                    }

                    if (data.code !== 0) {
                        console.error('Échec publication WebRTC:', data);
                        throw new Error(`Échec publication: ${data.error || 'Erreur inconnue'}`);
                    }

                    console.log('Étape 13: Définition description distante');
                    await peerConnection.setRemoteDescription({
                        type: 'answer',
                        sdp: data.sdp
                    });

                    console.log('Étape 14: Attente établissement flux');
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    const hlsUrl = `http://localhost:8080/hls/live/{{ session.id }}_{{ user.id }}.m3u8`;
                    console.log('Étape 15: URL HLS:', hlsUrl);

                    const token = localStorage.getItem('access_token');
                    console.log('Étape 16: Jeton:', token ? 'Présent' : 'Manquant');
                    if (!token) {
                        throw new Error('Jeton d’authentification manquant');
                    }

                    console.log('Étape 17: Envoi stockage URL HLS');
                    const storeResponse = await fetch('{{ url_for("tnt.store_broadcast_url") }}', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            session_id: {{ session.id }},
                            hls_url: hlsUrl
                        })
                    });

                    console.log('Étape 18: Réponse stockage, statut:', storeResponse.status);
                    if (!storeResponse.ok) {
                        const errorText = await storeResponse.text();
                        console.error('Erreur stockage URL HLS:', errorText);
                        throw new Error(`Échec stockage URL HLS: ${storeResponse.status} ${errorText}`);
                    }

                    console.log('Étape 19: Émission événement SocketIO');
                    socket.emit('start_broadcast', {
                        session_id: {{ session.id }},
                        user_id: {{ user.id }},
                        hls_url: hlsUrl
                    });

                    console.log('Étape 20: Mise à jour interface');
                    startBroadcastButton.style.display = 'none';
                    stopBroadcastButton.style.display = 'inline-block';
                    console.log('Diffusion démarrée');
                } catch (error) {
                    console.error('Erreur démarrage diffusion:', error);
                    alert(`Impossible de démarrer la diffusion: ${error.message}`);
                    if (localStream) {
                        localStream.getTracks().forEach(track => track.stop());
                    }
                    if (peerConnection) {
                        peerConnection.close();
                    }
                    localStream = null;
                    peerConnection = null;
                    showNoStreamMessage();
                }
            });

            stopBroadcastButton.addEventListener('click', async () => {
                console.log('Arrêt diffusion');
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (peerConnection) {
                    peerConnection.close();
                }
                localStream = null;
                peerConnection = null;

                startBroadcastButton.style.display = 'inline-block';
                stopBroadcastButton.style.display = 'none';
                sessionStorage.removeItem('currentHlsUrl');
                showNoStreamMessage();
                console.log('Diffusion arrêtée');
            });
        {% endif %}

        // Initialisation au chargement de la page
        const hlsUrls = {{ hls_urls | tojson }};
        console.log('hls_urls reçu:', hlsUrls);
        const savedHlsUrl = sessionStorage.getItem('currentHlsUrl');
        if (savedHlsUrl) {
            console.log('Chargement depuis sessionStorage:', savedHlsUrl);
            loadVideo(savedHlsUrl);
        } else if (hlsUrls && hlsUrls.length > 0 && hlsUrls[0].hls_url) {
            console.log('Chargement depuis hls_urls:', hlsUrls[0].hls_url);
            loadVideo(hlsUrls[0].hls_url);
        } else {
            console.log('Aucun flux HLS disponible');
            showNoStreamMessage();
        }
    </script>
</body>
</html>
{% endblock %}